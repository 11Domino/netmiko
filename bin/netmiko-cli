#!/usr/bin/env python

from __future__ import print_function
from __future__ import unicode_literals

import argparse
import sys
import io
from netmiko import ConnectHandler


def load_devices(yaml_file='.netmiko.cfg'):
    """Parses .netmiko.cfg file, returning its contents as a dict."""
    try:
        import yaml
    except ImportError:
        sys.exit("Unable to import yaml module.")

    try:
        with io.open(yaml_file, encoding='utf-8') as fname:
            return yaml.load(fname)
    except IOError:
        sys.exit("Unable to open YAML file: {0}".format(yaml_file))

def main():
    parser = argparse.ArgumentParser(description="Experimental netmiko-cli command")
    parser.add_argument("device_id", help="Device to connect to", action="store", type=str)
    parser.add_argument("--cmd", help="Remote command to execute", action="store", type=str)
    parser.add_argument("--username", help="Username", action="store", type=str)
    parser.add_argument("--password", help="Password", action="store", type=str)
    cli_args = parser.parse_args()
    cli_command = cli_args.cmd
    device_id = cli_args.device_id

    my_devices = load_devices()
    try:
        device = my_devices[device_id]
    except KeyError:
        print("Key Error")
        sys.exit(1)

    net_connect = ConnectHandler(**device)
    output = net_connect.send_command_expect(cli_command)
    print(output)
    return 0

if __name__ == "__main__":
    sys.exit(main())
